#!/bin/bash -e
 
set -e -x

<%
  def spec_ext_ip
    if spec.networks.vip.present?
      spec.networks.vip.ip
    elsif spec.networks.service_public.present?
      spec.networks.service_public.ip
    else
      spec.address
    end
  end
  WSO2_SERVER_URL = spec_ext_ip
%>

SCRIPT_NAME=$(basename $0)
JOB_NAME=api-gateway
JOB_ID=<%= spec.id %>
SERVER_URL=<%="#{WSO2_SERVER_URL}"%>
RUN_DIR=/var/vcap/sys/run/${JOB_NAME}
DB_PKG_DIR=/var/vcap/packages/mariadb
DB_LOG_DIR=/var/vcap/sys/log/database
DB_CONF_DIR=/var/vcap/jobs/${JOB_NAME}/config/database
PIDFILE=${RUN_DIR}/mariadb.pid
DATA_DIR=/var/vcap/store/mariadb
APIM_SCHEMA=("regdb" "WSO2AM_DB" "WSO2MB_DB")
ADMIN_PW="<%= p('database.admin_password')%>"

source /var/vcap/packages/common/syslog_utils.sh

tee_output_to_sys_log_and_file ${DB_LOG_DIR} ${SCRIPT_NAME}

case $1 in
 
  start)

    echo "##### STARTING :: MARIA-DB :: SCRIPT_NAME :: ${SCRIPT_NAME}"
    echo "##### STARTING :: MARIA-DB :: DB_PKG_DIR :: ${DB_PKG_DIR}"
    echo "##### STARTING :: MARIA-DB :: DB_CONF_DIR :: ${DB_CONF_DIR}"
    echo "##### STARTING :: MARIA-DB :: PIDFILE :: ${PIDFILE}"
 
    nohup ${DB_PKG_DIR}/bin/mysqld_safe --defaults-file=${DB_CONF_DIR}/mariadb.cnf --user=vcap \
          >>${DB_LOG_DIR}/${SCRIPT_NAME}.out.log \
          2>>${DB_LOG_DIR}/${SCRIPT_NAME}.err.log &
 
    RETVAL=$?

    if [ ${RETVAL} -ne 0 ]; then
      echo "##### START :: MARIA-DB :: FAIL :: ${RETVAL}"
      exit 1
    fi

    echo "##### MARIA-DB :: RETVAL :: ${RETVAL}"
    CYCLE=0

    while [ ! -e ${RUN_DIR}/mysql.sock ]
    do
      CYCLE=`expr ${CYCLE} + 1`
      echo "::::: STARTING .................. ${CYCLE}"
      sleep 20

      if [ ${CYCLE} -eq 3 ]; then
        echo "##### START :: MARIA-DB :: FAIL ::"
        break
      fi
    done

    source /var/vcap/jobs/${JOB_NAME}/bin/db_query_ctl

    check_vm_status

    echo "##### CHECK VM STATUS :: ${VM_STATUS}"

    if [ ! -d "${DATA_DIR}/${APIM_SCHEMA[0]}" -o ! -d "${DATA_DIR}/${APIM_SCHEMA[1]}" -o ! -d "${DATA_DIR}/${APIM_SCHEMA[2]}" ]; then

      echo "##### API-GATEWAY ::: DATABASE SCRIPT ::::: MARIA DB USER SETTING "
      ${DB_PKG_DIR}/bin/mysql -u root < ${DB_CONF_DIR}/mariadb_init.sql
      create_database

    else

      if [ ${VM_STATUS} -eq 1 ]; then
        echo "##### API-GATEWAY ::: RECREATE "
        create_database
      fi
    fi
    
    echo "##### START :: MARIA-DB :: SUCCESS :: ${PIDFILE}"
 
    ;;
 
  stop)
    echo "##### STOP :: MARIA-DB :: SUCCESS :: ${PIDFILE}"
    sudo kill $(cat $PIDFILE)
    ;;
 
  *)
    echo "Usage: mariadb_ctl {start|stop}"
    ;;
 
esac
exit 0
