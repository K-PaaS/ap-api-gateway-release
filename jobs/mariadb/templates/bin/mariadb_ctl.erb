#!/bin/bash -e
 
set -e -x
 
JOB_NAME=mariadb
BASE_DIR=/var/vcap/packages/${JOB_NAME}
STORE_DIR=/var/vcap/store/${JOB_NAME}
 
source /var/vcap/jobs/$JOB_NAME/helpers/ctl_setup.sh ${JOB_NAME}

CONF_FILE=${JOB_DIR}/config/mariadb.cnf
 
case $1 in
 
  start)

    echo "##### STARTING :: MARIA-DB :: PIDFILE :: ${PIDFILE}"
    echo "##### STARTING :: MARIA-DB :: BASE_DIR :: ${BASE_DIR}"
    echo "##### STARTING :: MARIA-DB :: STORE_DIR :: ${STORE_DIR}"
    echo "##### STARTING :: MARIA-DB :: CONF_FILE :: ${CONF_FILE}"
 
    if [ ! -d /usr/local/mysql ]; then
      echo "##### STARTING :: MARIA-DB :: link :: /usr/local/mysql -- ${BASE_DIR}"
      ln -s ${BASE_DIR} /usr/local/mysql
    fi
 
    if [ ! -e /tmp/mysql.sock ]; then
      echo "##### STARTING :: MARIA-DB :: link : /tmp/mysql.sock -- ${RUN_DIR}/mysql.sock"
      ln -sf ${RUN_DIR}/mysql.sock /tmp/mysql.sock
    fi
 
    if [ ! -f /etc/mariadb/mariadb.cnf ]; then
      echo "##### STARTING :: MARIA-DB :: link : /etc/mariadb/mariadb.cnf -- ${CONF_FILE}"
      mkdir -p /etc/mariadb
      ln -sf ${CONF_FILE} /etc/mariadb/mariadb.cnf
    fi
 
    if [ ! -d "${STORE_DIR}" ]; then
      echo "##### STARTING :: MARIA-DB :: mysql_install_db defaults-file = ${CONF_FILE}"
 
      mkdir -p ${STORE_DIR}
      chown -R vcap:vcap ${STORE_DIR}
 
      cd ${BASE_DIR}
      ./scripts/mysql_install_db --defaults-file=${CONF_FILE} --user=vcap
 
    fi
 
    ${BASE_DIR}/bin/mysqld_safe --defaults-file=${CONF_FILE} --user=vcap
 
    RETVAL=$?
 
    [ $RETVAL -ne 0 ] && exit $RETVAL
 
    echo "##### START :: MARIA-DB :: SUCCESS :: ${PIDFILE}"
 
    ;;
 
  stop)
    echo "stop"
    sudo kill $(cat $PIDFILE)
    ;;
 
  *)
    echo "Usage: mariadb_ctl {start|stop}"
    ;;
 
esac
exit 0
